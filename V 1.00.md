import maya.cmds as cmds
import random

tree_counter = 1  # شمارنده برای ایجاد نام منحصر به فرد برای هر درخت
tree_offset = 5  # فاصله ثابت برای جابجایی درخت‌ها در محور X

def create_cone(radius=0.5, height=5, subdivisions=5, height_subdivisions=5, height_option_menu=3, name="myCone", branches=2):
    """ایجاد یک مخروط (تنه درخت) با تغییرات تصادفی و شاخه‌ها"""
    global tree_counter, tree_offset
    unique_name = f"{name}_{tree_counter}"
    tree_counter += 1

    if cmds.objExists(unique_name):
        cmds.warning(f"An object with the name '{unique_name}' already exists.")
        return

    if branches not in [1, 2]:
        cmds.error("The 'branches' parameter must be either 1 or 2.")
        return

    if height_option_menu == 1:
        random_translation_range = 0.2
        random_rotation_range = 2
    elif height_option_menu == 2:
        random_translation_range = 0.5
        random_rotation_range = 2
    elif height_option_menu in [3, 4, 5]:
        random_translation_range = 0.8
        random_rotation_range = 2
    else:
        random_translation_range = 0.8
        random_rotation_range = 2

    # ایجاد تنه درخت
    cone = cmds.polyCone(r=radius, h=height, sx=subdivisions, sy=height_subdivisions, name=unique_name)

    random_offset_x = tree_offset * (tree_counter - 1)
    cmds.move(random_offset_x, 0, 0, cone[0], relative=True)

    for i in range(height_subdivisions):
        loop = f"{cone[0]}.e[{i*subdivisions}:{(i+1)*subdivisions-1}]"
        cmds.select(loop)

        random_translation_x = random.uniform(-random_translation_range, random_translation_range)
        random_translation_z = random.uniform(-random_translation_range, random_translation_range)
        random_rotation_x = random.uniform(-random_rotation_range, random_rotation_range)
        random_rotation_z = random.uniform(-random_rotation_range, random_rotation_range)

        cmds.move(random_translation_x, 0, random_translation_z, loop, relative=True)
        cmds.rotate(random_rotation_x, 0, random_rotation_z, loop, relative=True)

        if i >= height_subdivisions - 1:
            cmds.polyBevel3(loop, fraction=0.1, offsetAsFraction=True, autoFit=True, segments=2, worldSpace=True)

        if i < height_subdivisions - 1:
            lower_loop = f"{cone[0]}.e[{(i+1)*subdivisions}:{(i+2)*subdivisions-1}]"
            cmds.select(lower_loop)
            cmds.move(random_translation_x * 0.8, 0, random_translation_z * 0.8, lower_loop, relative=True)
            cmds.rotate(random_rotation_x * 0.8, 0, random_rotation_z * 0.8, lower_loop, relative=True)

    # تعریف لیست فیس‌های معتبر
    if height_subdivisions == 5:
        valid_faces = [27, 32, 33, 35, 26, 29, 28, 31, 30, 34]
    elif height_subdivisions == 7:
        valid_faces = [43, 41, 39, 37, 38, 40, 42, 44, 36]
    elif height_subdivisions == 9:
        valid_faces = [49, 51, 48, 52, 53, 54, 55, 47, 46]
    else:
        valid_faces = [23, 29, 27, 25, 28, 21, 22, 24, 27, 20]

    top_surface1 = f"{cone[0]}.f[{random.choice(valid_faces)}]"

    top_surfaces = []
    if branches == 1:
        top_surfaces.append([top_surface1])
    elif branches == 2:
        valid_faces_copy = valid_faces.copy()
        valid_faces_copy.remove(int(top_surface1.split("[")[-1].rstrip("]")))
        top_surface2 = f"{cone[0]}.f[{random.choice(valid_faces_copy)}]"

        top_surfaces.append([top_surface1])
        top_surfaces.append([top_surface2])

    for surfaces in top_surfaces:
        cmds.select(surfaces)
        cmds.polyExtrudeFacet(localTranslate=(0, 0.5, 0.5))
        cmds.polyExtrudeFacet(localTranslate=(0, 1, 1))

    # ایجاد برگ‌ها
    create_leaves(cone[0])

    return cone


def create_leaf(position):
    leaf = cmds.polySphere(r=1.2, sx=6, sy=4, name="leaf")[0]
    cmds.move(position[0], position[1], position[2], leaf)
    # تغییر مقیاس برگ به صورت تصادفی
    scale_factor = random.uniform(0.5, 1.5)  # مقیاس برگ بین 0.5 تا 1.5
    cmds.scale(scale_factor, scale_factor, scale_factor, leaf)
     # چرخش تصادفی برگ
    rotation_x = random.uniform(0, 360)
    rotation_y = random.uniform(0, 360)
    rotation_z = random.uniform(0, 360)
    cmds.rotate(rotation_x, rotation_y, rotation_z, leaf)

    # تغییر موقعیت تصادفی برگ در اطراف موقعیت اصلی
    offset_x = random.uniform(-0.5, 0.5)
    offset_y = random.uniform(0.2, 1.0)  # افزایش موقعیت در محور Y به دلیل جاذبه طبیعی
    offset_z = random.uniform(-0.5, 0.5)
    cmds.move(offset_x, offset_y, offset_z, leaf, relative=True)
    return leaf


def get_highest_vertex(tree_name):
    vertices = cmds.polyListComponentConversion(tree_name, toVertex=True)
    vertices = cmds.ls(vertices, flatten=True)

    highest_vertex = None
    highest_y_position = float('-inf')

    for vertex in vertices:
        position = cmds.pointPosition(vertex, world=True)
        y_position = position[1]
        if y_position > highest_y_position:
            highest_y_position = y_position
            highest_vertex = vertex

    return highest_vertex


def get_leaf_positions(tree_name):
    highest_vertex = get_highest_vertex(tree_name)
    highest_vertex_position = cmds.pointPosition(highest_vertex, world=True)

    # به جای مقداردهی سخت، ورتکس‌های مناسب پیدا کن یا تغییر بده
    branch1_position = cmds.pointPosition(f"{tree_name}.vtx[48]")
    branch2_position = cmds.pointPosition(f"{tree_name}.vtx[40]")
    

    branch_positions = [
        highest_vertex_position,
        branch1_position,
        branch2_position,
       
        
    ]
    return branch_positions


def create_leaves(tree_name):
    branch_positions = get_leaf_positions(tree_name)
    for position in branch_positions:
        create_leaf(position)

def create_tree_materials(cone_name, leaf_name):
    # ایجاد متریال برای تنه درخت
    tree_material = cmds.shadingNode('aiStandardSurface', asShader=True, name="tree_material")
    tree_material_sg = cmds.setAttr(tree_material + '.color', 0.5, 0.25, 0.1, type="double3")  # رنگ چوبی
    cmds.setAttr(tree_material + '.roughness', 0.6)  # زبری سطح
    cmds.setAttr(tree_material + '.specular', 0.2)  # براقیت کم
    cmds.select(cone_name)
    cmds.hyperShade(assign=tree_material)  # اعمال متریال به تنه درخت
    
    # ایجاد متریال برای برگ‌ها
    leaf_material = cmds.shadingNode('aiStandardSurface', asShader=True, name="leaf_material")
    leaf_material_sg = cmds.setAttr(leaf_material + '.color', 0.2, 0.8, 0.2, type="double3")  # رنگ سبز برگ
    cmds.setAttr(leaf_material + '.transmission', 0.6)  # شفافیت برگ‌ها
    cmds.setAttr(leaf_material + '.roughness', 0.3)  # زبری سطح برگ
    cmds.select(leaf_name)
    cmds.hyperShade(assign=leaf_material)  # اعمال متریال به برگ‌ها



def create_ui():
    if cmds.window("coneUI", exists=True):
        cmds.deleteUI("coneUI")

    window = cmds.window("coneUI", title="Create Tree", widthHeight=(350, 500), backgroundColor=(0.2, 0.2, 0.2))
    cmds.columnLayout(adjustableColumn=True, rowSpacing=10)

    cmds.text(label="Tree Creator", font="boldLabelFont", align="center", height=30)

    cmds.text(label="Radius:", font="boldLabelFont", align="left")
    radius_option_menu = cmds.optionMenu(label="Select Radius")
    cmds.menuItem(label="Ultra Thin")
    cmds.menuItem(label="Thin")
    cmds.menuItem(label="Medium")
    cmds.menuItem(label="Fat")
    cmds.menuItem(label="Heavy")
    cmds.menuItem(label="Full Heavy")
    cmds.optionMenu(radius_option_menu, edit=True, select=3)

    cmds.separator(height=10, style="in")

    cmds.text(label="Height:", font="boldLabelFont", align="left")
    height_option_menu = cmds.optionMenu(label="Select Height")
    cmds.menuItem(label="Very Short")
    cmds.menuItem(label="Short")
    cmds.menuItem(label="Medium")
    cmds.menuItem(label="Tall")
    cmds.menuItem(label="Very Tall")
    cmds.optionMenu(height_option_menu, edit=True, select=3)

    cmds.separator(height=10, style="in")

    cmds.text(label="Height Subdivisions:", font="boldLabelFont", align="left")
    height_subdivisions_option_menu = cmds.optionMenu(label="Select Height Subdivisions")
    cmds.menuItem(label="Normal (5)")
    cmds.menuItem(label="Low Twist (7)")
    cmds.menuItem(label="High Twist (9)")
    cmds.optionMenu(height_subdivisions_option_menu, edit=True, select=1)

    cmds.separator(height=10, style="in")

    cmds.text(label="Branches:", font="boldLabelFont", align="left")
    branches_field = cmds.intField(value=2)

    cmds.separator(height=10, style="in")

    cmds.button(label="Create Tree", height=40, backgroundColor=(0.4, 0.8, 0.4), command=lambda *args: create_cone(
        radius={
            1: 0.3,
            2: 0.5,
            3: 0.7,
            4: 1.0,
            5: 1.5,
            6: 2.0
        }[cmds.optionMenu(radius_option_menu, query=True, select=True)],
        height={
            1: 2.0,
            2: 3.0,
            3: 5.0,
            4: 7.0,
            5: 9.0
        }[cmds.optionMenu(height_option_menu, query=True, select=True)],
        height_subdivisions={
            1: 5,
            2: 7,
            3: 9
        }[cmds.optionMenu(height_subdivisions_option_menu, query=True, select=True)],
        subdivisions=5,
        branches=cmds.intField(branches_field, query=True, value=True),
        height_option_menu=cmds.optionMenu(height_option_menu, query=True, select=True),
        name="Tree"
    ))

    cmds.showWindow(window)


def main():
    create_ui()


main()
